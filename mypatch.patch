
diff -ru migrateWork/components/MkSignin.vue src/components/MkSignin.vue
--- migrateWork/components/MkSignin.vue	2023-02-19 20:32:39
+++ src/components/MkSignin.vue	2023-02-19 19:03:12
@@ -1,111 +1,41 @@
 <template>
-  <form
-    class="eppvobhk"
-    :class="{ signing, totpLogin }"
-    @submit.prevent="onSubmit"
-  >
-    <div class="auth _gaps_m">
-      <div
-        v-show="withAvatar"
-        class="avatar"
-        :style="{
-          backgroundImage: user ? `url('${user.avatarUrl}')` : null,
-          marginBottom: message ? '1.5em' : null,
-        }"
-      ></div>
-      <MkInfo v-if="message">
-        {{ message }}
-      </MkInfo>
-      <div v-if="!totpLogin" class="normal-signin _gaps_m">
+  <form class="eppvobhk" :class="{ signing }" @submit.prevent="onSubmit">
+    <div class="normal-signin">
+      {{ i18n.ts.ririca.instance }}
+      <MkSelect v-model="instanceUrl" large model-value="misskey.io">
+        <option key="misskey.io" value="misskey.io" :selected="true">
+          Misskey.io
+        </option>
+        <option value="other">
+          {{ i18n.ts.ririca.selectInstanceYourself }}
+        </option>
+      </MkSelect>
+      <template v-if="instanceUrl === 'other'">
+        URL
         <MkInput
-          v-model="username"
-          :placeholder="i18n.ts.username"
-          type="text"
-          pattern="^[a-zA-Z0-9_]+$"
+          v-model="instanceUrlOther"
           :spellcheck="false"
-          autocomplete="username"
           autofocus
           required
-          data-cy-signin-username
-          @update:model-value="onUsernameChange"
-        >
-          <template #prefix>@</template>
-          <template #suffix>@{{ host }}</template>
-        </MkInput>
-        <MkInput
-          v-if="!user || (user && !user.usePasswordLessLogin)"
-          v-model="password"
-          :placeholder="i18n.ts.password"
-          type="password"
-          :with-password-toggle="true"
-          required
-          data-cy-signin-password
-        >
-          <template #prefix><i class="ti ti-lock"></i></template>
-          <template #caption
-            ><button class="_textButton" type="button" @click="resetPassword">
-              {{ i18n.ts.forgotPassword }}
-            </button></template
-          >
-        </MkInput>
-        <MkButton
-          type="submit"
-          large
-          primary
-          rounded
-          :disabled="signing"
-          style="margin: 0 auto"
-          >{{ signing ? i18n.ts.loggingIn : i18n.ts.login }}</MkButton
-        >
-      </div>
-      <div
-        v-if="totpLogin"
-        class="2fa-signin"
-        :class="{ securityKeys: user && user.securityKeys }"
+        />
+      </template>
+      {{ i18n.ts.ririca.accessToken }}
+      <MkInput
+        v-model="token"
+        :spellcheck="false"
+        autofocus
+        required
+        data-cy-signin-username
+      ></MkInput>
+      <MkButton
+        class="_formBlock"
+        type="submit"
+        primary
+        :disabled="signing"
+        style="margin: 0 auto"
       >
-        <div v-if="user && user.securityKeys" class="twofa-group tap-group">
-          <p>{{ i18n.ts.tapSecurityKey }}</p>
-          <MkButton v-if="!queryingKey" @click="queryKey">
-            {{ i18n.ts.retry }}
-          </MkButton>
-        </div>
-        <div v-if="user && user.securityKeys" class="or-hr">
-          <p class="or-msg">{{ i18n.ts.or }}</p>
-        </div>
-        <div class="twofa-group totp-group">
-          <p style="margin-bottom: 0">{{ i18n.ts.twoStepAuthentication }}</p>
-          <MkInput
-            v-if="user && user.usePasswordLessLogin"
-            v-model="password"
-            type="password"
-            :with-password-toggle="true"
-            required
-          >
-            <template #label>{{ i18n.ts.password }}</template>
-            <template #prefix><i class="ti ti-lock"></i></template>
-          </MkInput>
-          <MkInput
-            v-model="token"
-            type="text"
-            pattern="^[0-9]{6}$"
-            autocomplete="off"
-            :spellcheck="false"
-            required
-          >
-            <template #label>{{ i18n.ts.token }}</template>
-            <template #prefix><i class="ti ti-123"></i></template>
-          </MkInput>
-          <MkButton
-            type="submit"
-            :disabled="signing"
-            large
-            primary
-            rounded
-            style="margin: 0 auto"
-            >{{ signing ? i18n.ts.loggingIn : i18n.ts.login }}</MkButton
-          >
-        </div>
-      </div>
+        {{ signing ? i18n.ts.loggingIn : i18n.ts.login }}
+      </MkButton>
     </div>
   </form>
 </template>
@@ -117,7 +47,7 @@
 import MkButton from "@/components/MkButton.vue";
 import MkInput from "@/components/MkInput.vue";
 import MkInfo from "@/components/MkInfo.vue";
-import { apiUrl, host as configHost } from "@/config";
+import MkSelect from "@/components/MkSelect.vue";
 import { byteify, hexify } from "@/scripts/2fa";
 import * as os from "@/os";
 import { login } from "@/account";
@@ -129,14 +59,15 @@
 let username = $ref("");
 let password = $ref("");
 let token = $ref("");
-let host = $ref(toUnicode(configHost));
-let totpLogin = $ref(false);
 let credential = $ref(null);
 let challengeData = $ref(null);
 let queryingKey = $ref(false);
 let hCaptchaResponse = $ref(null);
 let reCaptchaResponse = $ref(null);
 
+const instanceUrl = $ref("");
+const instanceUrlOther = $ref("");
+
 const meta = $computed(() => instance);
 
 const emit = defineEmits<{
@@ -174,12 +105,21 @@
   );
 }
 
-function onLogin(res) {
+function onLogin(res: any) {
   if (props.autoSet) {
-    return login(res.i);
+    return login(res.i, res.instance);
   }
 }
 
+const instanceUrlResult = $computed(() => {
+  if (instanceUrl === "other") {
+    // うっかりhttps://を入れてもreplaceされるから大丈夫
+    // new URL.origin
+    return new URL("https://" + instanceUrlOther.replace("https://", ""))
+      .origin;
+  }
+  return "https://" + instanceUrl;
+});
 function queryKey() {
   queryingKey = true;
   return navigator.credentials
@@ -214,8 +154,8 @@
       });
     })
     .then((res) => {
-      emit("login", res);
-      return onLogin(res);
+      emit("login", { ...res, instance: instanceUrl });
+      return onLogin({ ...res, instance: instanceUrl });
     })
     .catch((err) => {
       if (err === null) return;
@@ -229,38 +169,10 @@
 
 function onSubmit() {
   signing = true;
-  if (!totpLogin && user && user.twoFactorEnabled) {
-    if (window.PublicKeyCredential && user.securityKeys) {
-      os.api("signin", {
-        username,
-        password,
-        "hcaptcha-response": hCaptchaResponse,
-        "g-recaptcha-response": reCaptchaResponse,
-      })
-        .then((res) => {
-          totpLogin = true;
-          signing = false;
-          challengeData = res;
-          return queryKey();
-        })
-        .catch(loginFailed);
-    } else {
-      totpLogin = true;
-      signing = false;
-    }
-  } else {
-    os.api("signin", {
-      username,
-      password,
-      "hcaptcha-response": hCaptchaResponse,
-      "g-recaptcha-response": reCaptchaResponse,
-      token: user && user.twoFactorEnabled ? token : undefined,
-    })
-      .then((res) => {
-        emit("login", res);
-        onLogin(res);
-      })
-      .catch(loginFailed);
+  console.log("submit");
+  if (!token.value) {
+    login(token, instanceUrlResult);
+    signing = false;
   }
 }

diff -ru migrateWork/init.ts src/init.ts
--- migrateWork/init.ts	2023-02-19 20:32:39
+++ src/init.ts	2023-02-19 18:32:27
@@ -1,9 +1,6 @@
 /**
  * Client entry point
  */
-// https://vitejs.dev/config/build-options.html#build-modulepreload
-import "vite/modulepreload-polyfill";
-
 import "@/style.scss";

 //#region account indexedDB migration
@@ -35,7 +32,7 @@
 import { version, ui, lang, host, updateLocale } from "@/config";
 import { applyTheme } from "@/scripts/theme";
 import { isDeviceDarkmode } from "@/scripts/is-device-darkmode";
-import { i18n, updateI18n } from "@/i18n";
+import { i18n, setLanguage } from "@/i18n";
 import { confirm, alert, post, popup, toast } from "@/os";
 import { stream } from "@/stream";
 import * as sound from "@/scripts/sound";
@@ -53,568 +50,612 @@
 import { deckStore } from "./ui/deck/deck-store";
 import { miLocalStorage } from "./local-storage";
 import { claimAchievement, claimedAchievements } from "./scripts/achievements";
-import { fetchCustomEmojis } from "./custom-emojis";
+import { fetchCustomEmojis, streamEmojis } from "./custom-emojis";
+import { Device } from "@capacitor/device";
+import lightTheme from "@/themes/_light.json5";
+import OneSignal from "onesignal-cordova-plugin";
+import { App } from "@capacitor/app";
+export let storedDeviceInfo: Object;]

diff -ru migrateWork/ui/visitor/b.vue src/ui/visitor/b.vue
--- migrateWork/ui/visitor/b.vue	2023-02-19 20:32:43
+++ src/ui/visitor/b.vue	2023-02-18 22:55:31
@@ -2,10 +2,10 @@
   <div class="mk-app">
     <a
       v-if="root"
-      href="https://github.com/misskey-dev/misskey"
       target="_blank"
       class="github-corner"
       aria-label="View source on GitHub"
+      @click="linkToGithub"
       ><svg
         width="80"
         height="80"
@@ -72,35 +72,36 @@
 
     <Transition :name="$store.state.animation ? 'tray' : ''">
       <div v-if="showMenu" class="menu">
-        <MkA to="/" class="link" active-class="active"
-          ><i class="ti ti-home icon"></i>{{ $ts.home }}</MkA
-        >
+        <MkA to="/" class="link" active-class="active">
+          <i class="ti ti-home icon"></i>{{ $ts.home }}
+        </MkA>
         <MkA
           v-if="isTimelineAvailable"
           to="/timeline"
           class="link"
           active-class="active"
-          ><i class="ti ti-message icon"></i>{{ $ts.timeline }}</MkA
         >
-        <MkA to="/explore" class="link" active-class="active"
-          ><i class="ti ti-hash icon"></i>{{ $ts.explore }}</MkA
-        >
-        <MkA to="/announcements" class="link" active-class="active"
-          ><i class="ti ti-speakerphone icon"></i>{{ $ts.announcements }}</MkA
-        >
-        <MkA to="/channels" class="link" active-class="active"
-          ><i class="ti ti-device-tv icon"></i>{{ $ts.channel }}</MkA
-        >
+          <i class="ti ti-message icon"></i>{{ $ts.timeline }}
+        </MkA>
+        <MkA to="/explore" class="link" active-class="active">
+          <i class="ti ti-hash icon"></i>{{ $ts.explore }}
+        </MkA>
+        <MkA to="/announcements" class="link" active-class="active">
+          <i class="ti ti-speakerphone icon"></i>{{ $ts.announcements }}
+        </MkA>
+        <MkA to="/channels" class="link" active-class="active">
+          <i class="ti ti-device-tv icon"></i>{{ $ts.channel }}
+        </MkA>
         <div class="divider"></div>
-        <MkA to="/pages" class="link" active-class="active"
-          ><i class="ti ti-news icon"></i>{{ $ts.pages }}</MkA
-        >
-        <MkA to="/play" class="link" active-class="active"
-          ><i class="ti ti-player-play icon"></i>Play</MkA
-        >
-        <MkA to="/gallery" class="link" active-class="active"
-          ><i class="ti ti-icons icon"></i>{{ $ts.gallery }}</MkA
-        >
+        <MkA to="/pages" class="link" active-class="active">
+          <i class="ti ti-news icon"></i>{{ $ts.pages }}
+        </MkA>
+        <MkA to="/play" class="link" active-class="active">
+          <i class="ti ti-player-play icon"></i>Play
+        </MkA>
+        <MkA to="/gallery" class="link" active-class="active">
+          <i class="ti ti-icons icon"></i>{{ $ts.gallery }}
+        </MkA>
         <div class="action">
           <button class="_buttonPrimary" @click="signup()">
             {{ $ts.signup }}
@@ -131,6 +132,8 @@
   provideMetadataReceiver,
   setPageMetadata,
 } from "@/scripts/page-metadata";
+import { i18n } from "@/i18n";
+import { MenuA } from "@/types/menu";
 
 const DESKTOP_THRESHOLD = 1100;
 
@@ -144,18 +147,33 @@
   }
 });
 
+function linkToGithub() {
+  const misskeyLink: MenuA = {
+    type: "a",
+    target: "_blank",
+    href: "https://github.com/misskey-dev/misskey",
+    text: i18n.ts.aboutMisskey,
+  };
+  const missRirica: MenuA = {
+    type: "a",
+    target: "_blank",
+    href: "https://github.com/fruitriin/missRirica-client",
+    text: i18n.ts.ririca.name,
+  };
+  os.popupMenu([misskeyLink, missRirica]);
+}
+
 const announcements = {
   endpoint: "announcements",
   limit: 10,
 };
 
 const isTimelineAvailable =
-  instance.policies.ltlAvailable || instance.policies.gtlAvailable;
+  instance.policies?.ltlAvailable || instance.policies?.gtlAvailable;
 
 let showMenu = $ref(false);
 let isDesktop = $ref(window.innerWidth >= DESKTOP_THRESHOLD);
 let narrow = $ref(window.innerWidth < 1280);
-let meta = $ref();
 
 const keymap = $computed(() => {
   return {
@@ -168,10 +186,6 @@
 });
 
 const root = $computed(() => mainRouter.currentRoute.value.name === "index");
-
-os.api("meta", { detail: true }).then((res) => {
-  meta = res;
-});
 
 function signin() {
   os.popup(
Only in src/ui/visitor: b.vue.orig
